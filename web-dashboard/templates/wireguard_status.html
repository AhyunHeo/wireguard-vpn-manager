<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WireGuard Server Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .peer-card {
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        .peer-card.connected {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }
        .peer-card.disconnected {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.05);
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        .status-indicator.online {
            background-color: #28a745;
        }
        .status-indicator.offline {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .traffic-stats {
            font-family: 'Courier New', monospace;
        }
        #networkGraph {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-shield-lock"></i> WireGuard Server Monitor
            </span>
            <div class="text-white">
                <span id="serverTime"></span>
                <button class="btn btn-light btn-sm ms-3" onclick="refreshStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Server Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <h6>Server Status</h6>
                    <h3 id="serverStatus">
                        <span class="status-indicator online"></span>
                        Online
                    </h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h6>Connected Peers</h6>
                    <h3 id="connectedPeers">0 / 0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h6>Total Traffic</h6>
                    <h3 id="totalTraffic">0 MB</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h6>Server IP</h6>
                    <h3 id="serverIP">10.100.0.1/16</h3>
                </div>
            </div>
        </div>

        <!-- Interface Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <i class="bi bi-hdd-network"></i> Interface: wg0
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Public Key:</strong>
                                <div class="text-muted small" id="serverPublicKey">Loading...</div>
                            </div>
                            <div class="col-md-4">
                                <strong>Listening Port:</strong>
                                <div id="listeningPort">51820</div>
                            </div>
                            <div class="col-md-4">
                                <strong>Network:</strong>
                                <div id="serverNetwork">10.100.0.0/16</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Peers List -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-people"></i> Connected Peers
                    </div>
                    <div class="card-body">
                        <div id="peersList">
                            <div class="text-center text-muted">Loading peers...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Network Graph -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-diagram-3"></i> Network Topology
                    </div>
                    <div class="card-body">
                        <canvas id="networkGraph"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auto-refresh toggle -->
        <div class="position-fixed bottom-0 end-0 p-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                <label class="form-check-label" for="autoRefresh">
                    Auto-refresh (5s)
                </label>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let autoRefreshInterval;
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTimeDiff(timestamp) {
            if (!timestamp) return 'Never';
            const now = new Date();
            const then = new Date(timestamp);
            const diff = Math.floor((now - then) / 1000);
            
            if (diff < 60) return `${diff} seconds ago`;
            if (diff < 3600) return `${Math.floor(diff/60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff/3600)} hours ago`;
            return `${Math.floor(diff/86400)} days ago`;
        }

        async function refreshStatus() {
            try {
                // Get WireGuard status from API server (port 8090)
                const response = await fetch('http://192.168.0.68:8090/api/wireguard/status', {
                    headers: {
                        'Authorization': 'Bearer test-token-123'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch status');
                }
                
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('serverStatus').innerHTML = 
                    '<span class="status-indicator offline"></span>Error';
            }
        }

        function updateUI(data) {
            // Update server info
            if (data.interface) {
                document.getElementById('serverPublicKey').textContent = 
                    data.interface.public_key || 'N/A';
                document.getElementById('listeningPort').textContent = 
                    data.interface.port || '51820';
            }
            
            // Update peer count
            const connectedCount = data.peers ? 
                data.peers.filter(p => p.latest_handshake).length : 0;
            document.getElementById('connectedPeers').textContent = 
                `${connectedCount} / ${data.peer_count || 0}`;
            
            // Calculate total traffic
            let totalBytes = 0;
            if (data.peers) {
                data.peers.forEach(peer => {
                    if (peer.transfer) {
                        const parts = peer.transfer.split(',');
                        // Parse transfer data
                    }
                });
            }
            
            // Update peers list
            updatePeersList(data.peers || []);
            
            // Update network graph
            updateNetworkGraph(data);
        }

        function updatePeersList(peers) {
            const container = document.getElementById('peersList');
            
            if (peers.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No peers connected</div>';
                return;
            }
            
            let html = '';
            peers.forEach(peer => {
                const isConnected = peer.latest_handshake && peer.latest_handshake !== 'Never';
                const cardClass = isConnected ? 'connected' : 'disconnected';
                
                html += `
                    <div class="peer-card card mb-2 ${cardClass}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="mb-1">
                                        <span class="status-indicator ${isConnected ? 'online' : 'offline'}"></span>
                                        ${peer.allowed_ips || 'Unknown IP'}
                                    </h6>
                                    <div class="text-muted small">
                                        Public Key: ${peer.public_key.substring(0, 20)}...
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Last Handshake</small>
                                    <div>${peer.latest_handshake || 'Never'}</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Transfer</small>
                                    <div class="traffic-stats">${peer.transfer || '0 B / 0 B'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateNetworkGraph(data) {
            const canvas = document.getElementById('networkGraph');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 400;
            
            // Clear canvas with gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#f0f4f8');
            gradient.addColorStop(1, '#e2e8f0');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) / 3;
            
            // Draw grid lines for better visualization
            ctx.strokeStyle = '#cbd5e0';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < canvas.width; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 50) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
            
            // Draw server node (center)
            const serverRadius = 30;
            
            // Server glow effect
            ctx.shadowColor = '#667eea';
            ctx.shadowBlur = 20;
            
            // Server node gradient
            const serverGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, serverRadius);
            serverGradient.addColorStop(0, '#667eea');
            serverGradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = serverGradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, serverRadius, 0, 2 * Math.PI);
            ctx.fill();
            
            // Server icon
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('S', centerX, centerY);
            
            // Server label
            ctx.fillStyle = '#2d3748';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('10.100.0.1', centerX, centerY + serverRadius + 15);
            
            // Draw peer nodes
            if (data.peers && data.peers.length > 0) {
                const angleStep = (2 * Math.PI) / data.peers.length;
                
                data.peers.forEach((peer, index) => {
                    const angle = angleStep * index - Math.PI / 2; // Start from top
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    const isConnected = peer.latest_handshake && peer.latest_handshake !== 'Never';
                    
                    // Draw connection line
                    ctx.lineWidth = isConnected ? 3 : 1;
                    ctx.strokeStyle = isConnected ? '#48bb78' : '#fc8181';
                    
                    if (isConnected) {
                        // Animated dashed line for active connections
                        ctx.setLineDash([5, 5]);
                        ctx.lineDashOffset = (Date.now() / 100) % 10;
                    } else {
                        ctx.setLineDash([2, 8]);
                    }
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // Draw peer node
                    const nodeRadius = 20;
                    
                    // Node shadow
                    if (isConnected) {
                        ctx.shadowColor = '#48bb78';
                        ctx.shadowBlur = 10;
                    } else {
                        ctx.shadowColor = '#fc8181';
                        ctx.shadowBlur = 5;
                    }
                    
                    // Node gradient
                    const nodeGradient = ctx.createRadialGradient(x, y, 0, x, y, nodeRadius);
                    if (isConnected) {
                        nodeGradient.addColorStop(0, '#68d391');
                        nodeGradient.addColorStop(1, '#48bb78');
                    } else {
                        nodeGradient.addColorStop(0, '#fc8181');
                        nodeGradient.addColorStop(1, '#f56565');
                    }
                    
                    ctx.fillStyle = nodeGradient;
                    ctx.beginPath();
                    ctx.arc(x, y, nodeRadius, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Node icon
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(index + 1, x, y);
                    
                    // Node label (IP address)
                    ctx.fillStyle = '#2d3748';
                    ctx.font = '11px Arial';
                    const ip = peer.allowed_ips ? peer.allowed_ips.split('/')[0] : 'Unknown';
                    ctx.fillText(ip, x, y + nodeRadius + 12);
                    
                    // Connection status
                    if (isConnected) {
                        ctx.fillStyle = '#48bb78';
                        ctx.font = '10px Arial';
                        const handshakeText = peer.latest_handshake.includes('ago') ? 
                            peer.latest_handshake : 'Active';
                        ctx.fillText(handshakeText, x, y + nodeRadius + 24);
                    } else {
                        ctx.fillStyle = '#f56565';
                        ctx.font = '10px Arial';
                        ctx.fillText('Disconnected', x, y + nodeRadius + 24);
                    }
                    
                    // Traffic indicator
                    if (peer.transfer) {
                        const parts = peer.transfer.split(',');
                        if (parts.length >= 2) {
                            ctx.fillStyle = '#718096';
                            ctx.font = '9px Arial';
                            ctx.fillText(parts[0].trim(), x - 30, y - nodeRadius - 10);
                            ctx.fillText(parts[1].trim(), x + 30, y - nodeRadius - 10);
                        }
                    }
                });
            } else {
                // No peers message
                ctx.fillStyle = '#a0aec0';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No peers connected', centerX, centerY + 80);
            }
            
            // Draw legend
            ctx.shadowBlur = 0;
            const legendY = canvas.height - 30;
            
            // Connected legend
            ctx.fillStyle = '#48bb78';
            ctx.beginPath();
            ctx.arc(20, legendY, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillStyle = '#4a5568';
            ctx.font = '11px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Connected', 30, legendY + 3);
            
            // Disconnected legend
            ctx.fillStyle = '#f56565';
            ctx.beginPath();
            ctx.arc(100, legendY, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillStyle = '#4a5568';
            ctx.fillText('Disconnected', 110, legendY + 3);
            
            // Stats
            ctx.fillStyle = '#4a5568';
            ctx.textAlign = 'right';
            ctx.fillText(`Total Peers: ${data.peer_count || 0}`, canvas.width - 10, legendY + 3);
        }

        function updateServerTime() {
            const now = new Date();
            document.getElementById('serverTime').textContent = 
                now.toLocaleTimeString();
        }

        // Setup auto-refresh
        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                autoRefreshInterval = setInterval(refreshStatus, 5000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        });

        // Initial load
        refreshStatus();
        updateServerTime();
        setInterval(updateServerTime, 1000);
        autoRefreshInterval = setInterval(refreshStatus, 5000);
    </script>
</body>
</html>